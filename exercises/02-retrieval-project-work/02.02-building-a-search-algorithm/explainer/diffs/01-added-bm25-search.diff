commit 07af05f485e683798ec1cd5640dc11246a4a00f8
Author: Matt Pocock <mattpocockvoice@gmail.com>
Date:   Wed Oct 22 15:57:47 2025 +0100

    02.02.01 Added BM25 Search

diff --git a/package.json b/package.json
index 33cc607..108e686 100644
--- a/package.json
+++ b/package.json
@@ -1,56 +1,57 @@
 {
   "name": "ai-personal-assistant",
   "version": "0.1.0",
   "private": true,
   "scripts": {
     "dev": "next dev --turbopack",
     "build": "next build --turbopack",
     "start": "next start",
     "cherry-pick": "ai-hero-cli cherry-pick --branch=live-run-through",
     "reset": "ai-hero-cli reset --branch=live-run-through"
   },
   "dependencies": {
     "@ai-sdk/anthropic": "^2.0.40",
     "@ai-sdk/google": "^2.0.26",
     "@ai-sdk/react": "^2.0.85",
     "@radix-ui/react-avatar": "^1.1.10",
     "@radix-ui/react-collapsible": "^1.1.12",
     "@radix-ui/react-dialog": "^1.1.15",
     "@radix-ui/react-dropdown-menu": "^2.1.16",
     "@radix-ui/react-hover-card": "^1.1.15",
     "@radix-ui/react-progress": "^1.1.7",
     "@radix-ui/react-scroll-area": "^1.2.10",
     "@radix-ui/react-select": "^2.2.6",
     "@radix-ui/react-separator": "^1.1.7",
     "@radix-ui/react-slot": "^1.2.3",
     "@radix-ui/react-tooltip": "^1.2.8",
     "@radix-ui/react-use-controllable-state": "^1.2.2",
     "ai": "^5.0.85",
     "class-variance-authority": "^0.7.1",
     "clsx": "^2.1.1",
     "embla-carousel-react": "^8.6.0",
     "lucide-react": "^0.544.0",
     "nanoid": "^5.1.6",
     "next": "15.5.4",
     "next-themes": "^0.4.6",
+    "okapibm25": "^1.4.1",
     "react": "19.1.0",
     "react-dom": "19.1.0",
     "react-syntax-highlighter": "^15.6.6",
     "streamdown": "^1.3.0",
     "tailwind-merge": "^3.3.1",
     "tokenlens": "^1.3.1",
     "use-stick-to-bottom": "^1.1.1",
     "zod": "^4.1.11"
   },
   "devDependencies": {
     "@tailwindcss/postcss": "^4",
     "@types/node": "^20",
     "@types/react": "^19",
     "@types/react-dom": "^19",
     "@types/react-syntax-highlighter": "^15.5.13",
     "ai-hero-cli": "^0.2.3",
     "tailwindcss": "^4",
     "tw-animate-css": "^1.4.0",
     "typescript": "^5"
   }
 }
diff --git a/src/app/search.ts b/src/app/search.ts
new file mode 100644
index 0000000..849f941
--- /dev/null
+++ b/src/app/search.ts
@@ -0,0 +1,38 @@
+import BM25 from "okapibm25";
+import fs from "fs/promises";
+import path from "path";
+
+export interface Email {
+  id: string;
+  threadId: string;
+  from: string;
+  to: string | string[];
+  cc?: string[];
+  subject: string;
+  body: string;
+  timestamp: string;
+  inReplyTo?: string;
+  references?: string[];
+  labels?: string[];
+  arcId?: string;
+  phaseId?: number;
+}
+
+export async function searchWithBM25(keywords: string[], emails: Email[]) {
+  // Combine subject + body for richer text corpus
+  const corpus = emails.map((email) => `${email.subject} ${email.body}`);
+
+  // BM25 returns score array matching corpus order
+  const scores: number[] = (BM25 as any)(corpus, keywords);
+
+  // Map scores to emails, sort descending
+  return scores
+    .map((score, idx) => ({ score, email: emails[idx] }))
+    .sort((a, b) => b.score - a.score);
+}
+
+export async function loadEmails(): Promise<Email[]> {
+  const filePath = path.join(process.cwd(), "data", "emails.json");
+  const fileContent = await fs.readFile(filePath, "utf-8");
+  return JSON.parse(fileContent);
+}
diff --git a/src/app/search/page.tsx b/src/app/search/page.tsx
index c4f0f30..b03a004 100644
--- a/src/app/search/page.tsx
+++ b/src/app/search/page.tsx
@@ -1,126 +1,104 @@
+import { SideBar } from "@/components/side-bar";
 import { TopBar } from "@/components/top-bar";
-import { SearchInput } from "./search-input";
-import { EmailList } from "./email-list";
-import { SearchPagination } from "./search-pagination";
-import { PerPageSelector } from "./per-page-selector";
-import fs from "fs/promises";
-import path from "path";
 import { loadChats, loadMemories } from "@/lib/persistence-layer";
 import { CHAT_LIMIT } from "../page";
-import { SideBar } from "@/components/side-bar";
-
-interface Email {
-  id: string;
-  threadId: string;
-  from: string;
-  to: string | string[];
-  cc?: string[];
-  subject: string;
-  body: string;
-  timestamp: string;
-  inReplyTo?: string;
-  references?: string[];
-  labels?: string[];
-  arcId?: string;
-  phaseId?: number;
-}
-
-async function loadEmails(): Promise<Email[]> {
-  const filePath = path.join(process.cwd(), "data", "emails.json");
-  const fileContent = await fs.readFile(filePath, "utf-8");
-  return JSON.parse(fileContent);
-}
+import { EmailList } from "./email-list";
+import { PerPageSelector } from "./per-page-selector";
+import { SearchInput } from "./search-input";
+import { SearchPagination } from "./search-pagination";
+import { loadEmails, searchWithBM25 } from "../search";
 
 export default async function SearchPage(props: {
   searchParams: Promise<{ q?: string; page?: string; perPage?: string }>;
 }) {
   const searchParams = await props.searchParams;
   const query = searchParams.q || "";
   const page = Number(searchParams.page) || 1;
   const perPage = Number(searchParams.perPage) || 10;
 
   const allEmails = await loadEmails();
 
+  const emailsWithScores = await searchWithBM25(
+    query.toLowerCase().split(" "),
+    allEmails
+  );
+
   // Transform emails to match the expected format
-  const transformedEmails = allEmails
-    .map((email) => ({
+  const transformedEmails = emailsWithScores
+    .map(({ email, score }) => ({
       id: email.id,
       from: email.from,
       subject: email.subject,
       preview: email.body.substring(0, 100) + "...",
       content: email.body,
       date: email.timestamp,
+      score: score,
     }))
-    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
+    .sort((a, b) => b.score - a.score);
 
   // Filter emails based on search query
   const filteredEmails = query
-    ? transformedEmails.filter(
-        (email) =>
-          email.subject.toLowerCase().includes(query.toLowerCase()) ||
-          email.from.toLowerCase().includes(query.toLowerCase()) ||
-          email.content.toLowerCase().includes(query.toLowerCase())
-      )
+    ? transformedEmails.filter((email) => email.score > 0)
     : transformedEmails;
 
   const totalPages = Math.ceil(filteredEmails.length / perPage);
   const startIndex = (page - 1) * perPage;
   const paginatedEmails = filteredEmails.slice(
     startIndex,
     startIndex + perPage
   );
   const allChats = await loadChats();
   const chats = allChats.slice(0, CHAT_LIMIT);
   const memories = await loadMemories();
 
   return (
     <>
       <SideBar chats={chats} memories={memories} chatIdFromSearchParams={""} />
       <div className="h-screen flex flex-col w-full">
         <TopBar showSidebar={true} title="Data" />
         <div className="flex-1">
           <div className="max-w-4xl mx-auto xl:px-2 px-6 py-6">
             <div className="mb-6">
               <p className="text-sm text-muted-foreground">
                 Search through your email archive
               </p>
             </div>
 
             <div className="flex md:items-center md:justify-between gap-4 flex-col md:flex-row">
               <SearchInput initialQuery={query} currentPerPage={perPage} />
               <PerPageSelector currentPerPage={perPage} query={query} />
             </div>
 
             <div className="mt-6">
               <div className="flex items-center justify-between mb-3">
                 <p className="text-sm text-muted-foreground">
                   {query ? (
                     <>
                       Found {filteredEmails.length} result
                       {filteredEmails.length !== 1 ? "s" : ""} for &ldquo;
                       {query}
                       &rdquo;
                     </>
                   ) : (
                     <>Found {filteredEmails.length} emails</>
                   )}
                 </p>
               </div>
               <EmailList emails={paginatedEmails} />
               {totalPages > 1 && (
                 <div className="mt-6">
                   <SearchPagination
                     currentPage={page}
                     totalPages={totalPages}
                     query={query}
                     perPage={perPage}
                   />
                 </div>
               )}
             </div>
           </div>
         </div>
       </div>
     </>
   );
 }
