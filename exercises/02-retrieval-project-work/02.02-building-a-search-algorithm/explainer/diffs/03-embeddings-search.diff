commit 2384f1e5b97297b290a7f05be7fae898f03d5f2a
Author: Matt Pocock <mattpocockvoice@gmail.com>
Date:   Wed Oct 22 16:07:29 2025 +0100

    02.02.03 Embeddings Search

diff --git a/src/app/search.ts b/src/app/search.ts
index 5fd168f..fc7f4ec 100644
--- a/src/app/search.ts
+++ b/src/app/search.ts
@@ -1,7 +1,7 @@
 import BM25 from "okapibm25";
 import fs from "fs/promises";
 import path from "path";
-import { embedMany } from "ai";
+import { embed, embedMany, cosineSimilarity } from "ai";
 import { google } from "@ai-sdk/google";
 
 export interface Email {
@@ -102,3 +102,26 @@ export async function loadOrGenerateEmbeddings(
 
   return results;
 }
+
+export async function searchWithEmbeddings(query: string, emails: Email[]) {
+  // Load cached embeddings
+  const emailEmbeddings = await loadOrGenerateEmbeddings(emails);
+
+  // Generate query embedding
+  const { embedding: queryEmbedding } = await embed({
+    model: google.textEmbeddingModel("text-embedding-004"),
+    value: query,
+  });
+
+  // Calculate similarity scores
+  const results = emailEmbeddings.map(({ id, embedding }) => {
+    const email = emails.find((e) => e.id === id)!;
+    const score = cosineSimilarity(queryEmbedding, embedding);
+    return { score, email };
+  });
+
+  console.log("Results:", results.length);
+
+  // Sort by similarity descending
+  return results.sort((a, b) => b.score - a.score);
+}
diff --git a/src/app/search/page.tsx b/src/app/search/page.tsx
index cbaba67..fe2488a 100644
--- a/src/app/search/page.tsx
+++ b/src/app/search/page.tsx
@@ -2,111 +2,100 @@ import { SideBar } from "@/components/side-bar";
 import { TopBar } from "@/components/top-bar";
 import { loadChats, loadMemories } from "@/lib/persistence-layer";
 import { CHAT_LIMIT } from "../page";
+import { loadEmails, searchWithEmbeddings } from "../search";
 import { EmailList } from "./email-list";
 import { PerPageSelector } from "./per-page-selector";
 import { SearchInput } from "./search-input";
 import { SearchPagination } from "./search-pagination";
-import {
-  loadEmails,
-  loadOrGenerateEmbeddings,
-  searchWithBM25,
-} from "../search";
 
 export default async function SearchPage(props: {
   searchParams: Promise<{ q?: string; page?: string; perPage?: string }>;
 }) {
   const searchParams = await props.searchParams;
   const query = searchParams.q || "";
   const page = Number(searchParams.page) || 1;
   const perPage = Number(searchParams.perPage) || 10;
 
   const allEmails = await loadEmails();
 
-  const embeddings = await loadOrGenerateEmbeddings(allEmails);
-
-  console.log("Email embeddings loaded:", embeddings.length);
-
-  const emailsWithScores = await searchWithBM25(
-    query.toLowerCase().split(" "),
-    allEmails
-  );
+  const emailsWithScores = await searchWithEmbeddings(query, allEmails);
 
   // Transform emails to match the expected format
   const transformedEmails = emailsWithScores
     .map(({ email, score }) => ({
       id: email.id,
       from: email.from,
       subject: email.subject,
       preview: email.body.substring(0, 100) + "...",
       content: email.body,
       date: email.timestamp,
       score: score,
     }))
     .sort((a, b) => b.score - a.score);
 
   // Filter emails based on search query
   const filteredEmails = query
     ? transformedEmails.filter((email) => email.score > 0)
     : transformedEmails;
 
   const totalPages = Math.ceil(filteredEmails.length / perPage);
   const startIndex = (page - 1) * perPage;
   const paginatedEmails = filteredEmails.slice(
     startIndex,
     startIndex + perPage
   );
   const allChats = await loadChats();
   const chats = allChats.slice(0, CHAT_LIMIT);
   const memories = await loadMemories();
 
   return (
     <>
       <SideBar chats={chats} memories={memories} chatIdFromSearchParams={""} />
       <div className="h-screen flex flex-col w-full">
         <TopBar showSidebar={true} title="Data" />
         <div className="flex-1">
           <div className="max-w-4xl mx-auto xl:px-2 px-6 py-6">
             <div className="mb-6">
               <p className="text-sm text-muted-foreground">
                 Search through your email archive
               </p>
             </div>
 
             <div className="flex md:items-center md:justify-between gap-4 flex-col md:flex-row">
               <SearchInput initialQuery={query} currentPerPage={perPage} />
               <PerPageSelector currentPerPage={perPage} query={query} />
             </div>
 
             <div className="mt-6">
               <div className="flex items-center justify-between mb-3">
                 <p className="text-sm text-muted-foreground">
                   {query ? (
                     <>
                       Found {filteredEmails.length} result
                       {filteredEmails.length !== 1 ? "s" : ""} for &ldquo;
                       {query}
                       &rdquo;
                     </>
                   ) : (
                     <>Found {filteredEmails.length} emails</>
                   )}
                 </p>
               </div>
               <EmailList emails={paginatedEmails} />
               {totalPages > 1 && (
                 <div className="mt-6">
                   <SearchPagination
                     currentPage={page}
                     totalPages={totalPages}
                     query={query}
                     perPage={perPage}
                   />
                 </div>
               )}
             </div>
           </div>
         </div>
       </div>
     </>
   );
 }
